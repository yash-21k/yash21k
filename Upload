import org.junit.jupiter.api.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.concurrent.*;

public class AccountCustomerDAOProxyPerfTest {

    private static final Logger logger = LoggerFactory.getLogger(AccountCustomerDAOProxyPerfTest.class);

    // Adjust based on your system & API limits
    private static final int TOTAL_REQUESTS = 10_000;
    private static final int NUM_THREADS = 100;

    @Test
    public void perfTestBurstMode() throws InterruptedException {
        // 1️⃣ Setup
        accountCustomerDAOProxy.setConfigParams("dl-dev", "pdp-po-eu-instance-st", "default", 2);

        ExecutorService executor = Executors.newFixedThreadPool(NUM_THREADS);
        CountDownLatch startLatch = new CountDownLatch(1);
        CountDownLatch doneLatch = new CountDownLatch(TOTAL_REQUESTS);

        long startTime = System.currentTimeMillis();

        // 2️⃣ Prepare all 10,000 tasks
        for (int i = 0; i < TOTAL_REQUESTS; i++) {
            int finalI = i;
            executor.submit(() -> {
                try {
                    startLatch.await(); // wait for the "burst" signal

                    // your actual GCP logic
                    accountCustomerDAOProxy.retrieveCustomers("20#40000231003593");
                    accountCustomerDAOProxy.retrieveRecordWithPrefix("20#");

                    // log progress every 1000
                    if (finalI % 1000 == 0) {
                        logger.info("Progress: {} / {}", finalI, TOTAL_REQUESTS);
                    }

                } catch (Exception e) {
                    logger.error("Error at iteration {}", finalI, e);
                } finally {
                    doneLatch.countDown();
                }
            });
        }

        logger.info("All threads ready. Launching burst...");

        // 3️⃣ Fire all requests at once
        startLatch.countDown();

        // 4️⃣ Wait until all finish
        doneLatch.await();
        executor.shutdown();

        long endTime = System.currentTimeMillis();

        // 5️⃣ Performance summary
        logger.info("✅ Completed {} requests in {} ms", TOTAL_REQUESTS, (endTime - startTime));
        logger.info("⚙️ Average per request: {} ms", (endTime - startTime) / (double) TOTAL_REQUESTS);
    }
}